<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Inscrições Rugby LEGENDS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-100 */
        }
        h1, h2, h3 {
            font-family: 'Bebas Neue', cursive;
        }
        th, td {
            white-space: nowrap;
        }
        .table-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        /* Estilos do Modal de Detalhes */
        #detailsModal {
            transition: opacity 0.3s ease-in-out;
        }
        #detailsModalContent {
             transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8">
            <h1 class="text-5xl text-amber-400 mb-4 md:mb-0">Painel de Controle</h1>
            <div id="status" class="text-lg text-right">
                <span class="text-yellow-400">Conectando ao banco de dados...</span>
            </div>
        </header>

         <div class="mb-12">
             <div class="flex items-center mb-4">
                 <h2 class="text-4xl text-cyan-400 border-b-2 border-cyan-400/50 pb-2">Pedidos de Kits</h2>
                 <span id="kitOrdersCount" class="ml-4 text-3xl font-bold bg-gray-700 text-cyan-400 px-3 py-1 rounded-lg">0</span>
             </div>
             <div class="table-container overflow-x-auto bg-gray-800 p-4 rounded-xl shadow-lg">
                 <table class="min-w-full">
                     <thead class="bg-gray-900 sticky top-0">
                         <tr>
                             <th class="p-4 text-left text-cyan-400 tracking-wider">Data</th>
                             <th class="p-4 text-left text-cyan-400 tracking-wider">Comprador</th>
                             <th class="p-4 text-left text-cyan-400 tracking-wider">Celular</th>
                             <th class="p-4 text-left text-cyan-400 tracking-wider">Valor Total</th>
                             <th class="p-4 text-left text-cyan-400 tracking-wider">Kits</th>
                             <th class="p-4 text-center text-cyan-400 tracking-wider">Status</th>
                             <th class="p-4 text-center text-cyan-400 tracking-wider">Comprovante</th>
                             <th class="p-4 text-center text-cyan-400 tracking-wider">Ações</th>
                         </tr>
                     </thead>
                     <tbody id="kitOrdersTableBody">
                         </tbody>
                 </table>
                 <p id="no-kit-orders" class="text-center text-gray-400 py-8 text-lg hidden">Nenhum pedido de kit encontrado.</p>
             </div>
         </div>

        <div class="mb-12">
            <div class="flex items-center mb-4">
                <h2 class="text-4xl text-amber-400 border-b-2 border-amber-400/50 pb-2">Inscrições de Atletas</h2>
                <span id="inscriptionsCount" class="ml-4 text-3xl font-bold bg-gray-700 text-amber-400 px-3 py-1 rounded-lg">0</span>
            </div>
            <div class="table-container overflow-x-auto bg-gray-800 p-4 rounded-xl shadow-lg">
                <table class="min-w-full">
                    <thead class="bg-gray-900 sticky top-0">
                        <tr>
                            <th class="p-4 text-left text-amber-400 tracking-wider">Data</th>
                            <th class="p-4 text-left text-amber-400 tracking-wider">Nome Completo</th>
                            <th class="p-4 text-left text-amber-400 tracking-wider">Apelido</th>
                            <th class="p-4 text-left text-amber-400 tracking-wider">Celular</th>
                            <th class="p-4 text-left text-amber-400 tracking-wider">Idade</th>
                            <th class="p-4 text-left text-amber-400 tracking-wider">Posição</th>
                            <th class="p-4 text-left text-amber-400 tracking-wider">Equipe</th>
                            <th class="p-4 text-left text-amber-400 tracking-wider">Pacote Hotel?</th>
                            <th class="p-4 text-center text-amber-400 tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="inscriptionsTableBody">
                        </tbody>
                </table>
                <p id="no-inscriptions" class="text-center text-gray-400 py-8 text-lg hidden">Nenhuma inscrição de atleta encontrada.</p>
            </div>
        </div>
    </div>

    <!-- Modal Genérico para Detalhes e Imagens -->
    <div id="detailsModal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4">
        <div id="detailsModalContent" class="bg-gray-800 rounded-xl shadow-lg w-full max-w-lg p-6 relative transform scale-95 opacity-0">
             <button id="closeDetailsModal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
             <h3 id="modal-title" class="text-3xl text-cyan-400 mb-4">Detalhes</h3>
             <div id="modal-body" class="space-y-2 max-h-[60vh] overflow-y-auto">
                 <!-- Conteúdo dinâmico será inserido aqui -->
             </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkR9qaY8xzektPr0DninTxaFOhP3PX_Qo",
            authDomain: "encontrorugbylegends.firebaseapp.com",
            projectId: "encontrorugbylegends",
            storageBucket: "encontrorugbylegends.appspot.com",
            messagingSenderId: "228233608028",
            appId: "1:228233608028:web:952e04b9ef63aa70d15f99",
            measurementId: "G-054DYF3Z1E"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const inscriptionsTableBody = document.getElementById('inscriptionsTableBody');
        const kitOrdersTableBody = document.getElementById('kitOrdersTableBody');
        const noInscriptionsMessage = document.getElementById('no-inscriptions');
        const noKitOrdersMessage = document.getElementById('no-kit-orders');
        const statusDiv = document.getElementById('status');
        const inscriptionsCountSpan = document.getElementById('inscriptionsCount');
        const kitOrdersCountSpan = document.getElementById('kitOrdersCount');

        const detailsModal = document.getElementById('detailsModal');
        const detailsModalContent = document.getElementById('detailsModalContent');
        const closeDetailsModalBtn = document.getElementById('closeDetailsModal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        window.handleDelete = async (docId, name) => {
            if (confirm(`Tem certeza que deseja excluir o registro de "${name}"? Esta ação não pode ser desfeita.`)) {
                try {
                    await deleteDoc(doc(db, "inscriptions", docId));
                } catch (error) {
                    console.error("Erro ao excluir o documento: ", error);
                    alert(`Ocorreu um erro ao excluir o registro de "${name}".`);
                }
            }
        };

        window.approvePayment = async (docId, name) => {
             if (confirm(`Confirmar o pagamento para o pedido de "${name}"?`)) {
                 try {
                     const docRef = doc(db, "inscriptions", docId);
                     await updateDoc(docRef, { paymentStatus: 'approved' });
                 } catch (error) {
                     console.error("Erro ao aprovar pagamento: ", error);
                     alert(`Ocorreu um erro ao aprovar o pagamento de "${name}".`);
                 }
             }
        };
        
        // Função para mostrar detalhes dos kits
        window.showDetails = (kits) => {
            modalTitle.textContent = 'Detalhes do Pedido';
            modalBody.innerHTML = ''; // Limpa o corpo do modal
            const parsedKits = JSON.parse(decodeURIComponent(kits));
            parsedKits.forEach(kit => {
                const kitDetail = document.createElement('div');
                kitDetail.className = 'bg-gray-900 p-3 rounded-lg';
                kitDetail.innerHTML = `
                    <p class="font-bold text-lg text-white">${kit.shirtName}</p>
                    <p class="text-sm"><span class="text-gray-400">Número:</span> ${kit.shirtNumber || 'N/A'} | <span class="text-gray-400">Gênero:</span> ${kit.gender} | <span class="text-gray-400">Tamanho:</span> ${kit.size}</p>
                `;
                modalBody.appendChild(kitDetail);
            });
            openModal();
        };

        // Função para mostrar o comprovante
        window.showReceipt = (url) => {
            modalTitle.textContent = 'Comprovante de Pagamento';
            // Verifica se é um PDF ou uma imagem para renderizar corretamente
            if (url.toLowerCase().includes('.pdf')) {
                 modalBody.innerHTML = `<iframe src="${url}" class="w-full h-[70vh]" frameborder="0"></iframe>`;
            } else {
                 modalBody.innerHTML = `<img src="${url}" alt="Comprovante em tamanho grande" class="w-full h-auto rounded-lg">`;
            }
            openModal();
        }
        
        function openModal() {
            detailsModal.classList.remove('hidden');
            detailsModal.classList.add('flex');
            setTimeout(() => {
                detailsModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeDetailsModal() {
             detailsModalContent.classList.add('scale-95', 'opacity-0');
             setTimeout(() => {
                 detailsModal.classList.add('hidden');
                 detailsModal.classList.remove('flex');
             }, 300);
        }
        closeDetailsModalBtn.addEventListener('click', closeDetailsModal);


        signInAnonymously(auth).then(() => {
            const q = query(collection(db, "inscriptions"), orderBy("timestamp", "desc"));

            onSnapshot(q, (querySnapshot) => {
                
                inscriptionsTableBody.innerHTML = '';
                kitOrdersTableBody.innerHTML = '';
                
                let inscriptionsCounter = 0;
                let kitOrdersCounter = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const docId = doc.id;
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleString('pt-BR') : 'N/A';
                    const nameForActions = (data.fullName || data.buyerName).replace(/'/g, "\\'");

                    const actionsCell = `
                        <td class="p-4 text-center">
                            <button onclick="handleDelete('${docId}', '${nameForActions}')" class="text-red-500 hover:text-red-400" title="Excluir">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </td>
                    `;

                    if (data.purchaseType === 'kit_order') {
                        kitOrdersCounter++;
                        const row = document.createElement('tr');
                        row.classList.add('border-b', 'border-gray-700', 'hover:bg-gray-700/50');
                        const kitsJson = encodeURIComponent(JSON.stringify(data.kits));
                        
                        let statusHtml;
                        if(data.paymentStatus === 'approved'){
                            statusHtml = `<span class="bg-green-500 text-gray-900 font-bold text-xs py-1 px-3 rounded-full">Aprovado</span>`;
                        } else {
                            statusHtml = `<button onclick="approvePayment('${docId}', '${nameForActions}')" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold text-xs py-1 px-3 rounded-full transition-colors">Aprovar?</button>`;
                        }
                        
                        // --- NOVA CÉLULA DE COMPROVANTE COM IMAGEM ---
                        let receiptCellHtml = '<td class="p-4 text-center text-gray-500">N/A</td>'; // Padrão se não houver URL
                        if (data.receiptUrl) {
                            // Verifica se é PDF para mostrar um ícone diferente
                            if (data.receiptUrl.toLowerCase().includes('.pdf')) {
                                receiptCellHtml = `
                                    <td class="p-4 text-center">
                                        <button onclick="showReceipt('${data.receiptUrl}')" class="flex items-center justify-center mx-auto bg-red-700 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm" title="Ver PDF">
                                            <i data-lucide="file-text" class="w-5 h-5"></i>
                                        </button>
                                    </td>`;
                            } else {
                                receiptCellHtml = `
                                    <td class="p-4 text-center">
                                        <img src="${data.receiptUrl}" alt="Comprovante" class="w-24 h-auto rounded-md cursor-pointer transform hover:scale-110 transition-transform duration-200 mx-auto" onclick="showReceipt('${data.receiptUrl}')">
                                    </td>`;
                            }
                        }


                        row.innerHTML = `
                            <td class="p-4 text-sm text-gray-400">${date}</td>
                            <td class="p-4">${data.buyerName}</td>
                            <td class="p-4">${data.buyerCelular || '-'}</td>
                            <td class="p-4 font-bold text-green-400">R$ ${data.totalPrice.toFixed(2).replace('.', ',')}</td>
                            <td class="p-4"><button onclick="showDetails('${kitsJson}')" class="text-cyan-400 hover:underline">${data.kits.length} kit(s) - Ver Detalhes</button></td>
                            <td class="p-4 text-center">${statusHtml}</td>
                            ${receiptCellHtml}
                            ${actionsCell}
                        `;
                        kitOrdersTableBody.appendChild(row);

                    } else if (data.purchaseType === 'inscription') {
                        inscriptionsCounter++;
                        const packageStatusHtml = `<span class="${data.hasPackage === 'Sim' ? 'bg-green-500' : 'bg-yellow-500'} text-gray-900 font-bold text-xs py-1 px-3 rounded-full">${data.hasPackage || '-'}</span>`;
                        const row = document.createElement('tr');
                        row.classList.add('border-b', 'border-gray-700', 'hover:bg-gray-700/50');
                        row.innerHTML = `
                            <td class="p-4 text-sm text-gray-400">${date}</td>
                            <td class="p-4">${data.fullName}</td>
                            <td class="p-4">${data.nickname || '-'}</td>
                            <td class="p-4">${data.celular || '-'}</td>
                            <td class="p-4">${data.age || '-'}</td>
                            <td class="p-4">${data.position || '-'}</td>
                            <td class="p-4">${data.teamName || '-'}</td>
                            <td class="p-4">${packageStatusHtml}</td>
                            ${actionsCell}
                        `;
                        inscriptionsTableBody.appendChild(row);
                    }
                });
                
                statusDiv.innerHTML = `<span class="text-green-400">Conectado e atualizando em tempo real.</span>`;
                inscriptionsCountSpan.textContent = inscriptionsCounter;
                kitOrdersCountSpan.textContent = kitOrdersCounter;

                noInscriptionsMessage.classList.toggle('hidden', inscriptionsCounter > 0);
                noKitOrdersMessage.classList.toggle('hidden', kitOrdersCounter > 0);
                lucide.createIcons();

            }, (error) => {
                console.error("Error getting documents: ", error);
                statusDiv.innerHTML = `<span class="text-red-500">Erro de conexão com o banco de dados.</span>`;
            });
        }).catch((error) => {
            console.error("Anonymous sign-in failed:", error);
            statusDiv.innerHTML = `<span class="text-red-500">Falha na autenticação. Não é possível ler os dados.</span>`;
        });
    </script>
</body>
</html>
